#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

BUILD_DIR=$1
VENDOR_DIR="$BUILD_DIR/vendor/deployer"

mkdir -p $VENDOR_DIR

AWS_CLI_DIR="$VENDOR_DIR/aws-cli"

echo "-----> Installing AWS Client...."
mkdir -p $AWS_CLI_DIR
curl -O "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip"
unzip awscli-bundle.zip
rm -f awscli-bundle.zip
awscli-bundle/install -i $AWS_CLI_DIR -b $AWS_CLI_DIR/aws -i $AWS_CLI_DIR/bin/aws

HEROKU_CLI_DIR="$VENDOR_DIR/heroku-client"

echo "-----> Installing Heroku Client...."
mkdir -p $HEROKU_CLI_DIR
curl -s https://s3.amazonaws.com/assets.heroku.com/heroku-client/heroku-client.tgz | tar xz
mv heroku-client $HEROKU_CLI_DIR

GO_DIR="$VENDOR_DIR/go"

echo "-----> Installing go...."
mkdir -p $GO_DIR
curl -s https://storage.googleapis.com/golang/go1.7.3.linux-amd64.tar.gz | tar xz
mv go $GO_DIR

mkdir -p "$BUILD_DIR"/.profile.d
cat <<EOF >"$BUILD_DIR"/.profile.d/deployer.sh
export PATH=$PATH:/app/vendor/deployer/heroku-client/bin/heroku:/app/vendor/deployer/go/bin/go:/app/vendor/deployer/aws-cli/bin/aws"
EOF

echo "-----> I'm done, buddy."
