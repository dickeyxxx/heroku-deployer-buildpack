#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

# Clean up leaking environment
unset GIT_DIR

BUILD_DIR=$1
VENDOR_DIR="$BUILD_DIR/vendor/deployer"
BIN_DIR="$BUILD_DIR/vendor/bin"

mkdir -p $VENDOR_DIR
mkdir -p $BIN_DIR

# Required dependencies for the deployer itself
echo "-----> Installing Heroku Client...."
curl -s https://s3.amazonaws.com/assets.heroku.com/heroku-client/heroku-client.tgz | tar xz
mv heroku-client $VENDOR_DIR

echo "-----> Installing go...."
curl -s https://storage.googleapis.com/golang/go1.7.3.linux-amd64.tar.gz | tar xz
mv go $VENDOR_DIR


# Required dependencies for themuse (may need to move this somewhere else later)
mkdir -p $VENDOR_DIR/go-deps

export GOROOT=$VENDOR_DIR/go
export GOPATH=$VENDOR_DIR/go-deps
export PATH=$GOROOT/bin:$PATH

wget https://s3.amazonaws.com/tm-vendor/sassc
mv sassc $BIN_DIR
chmod +x $BIN_DIR/sassc

go get github.com/dailymuse/gosass

# Add python 2 wrapper so older library compiles work
printf '#!/usr/bin/env bash\n\nPYTHONHOME=/usr\n\n/usr/bin/python2.7 "$@"' | tee $BIN_DIR/python2.7 $BIN_DIR/python2
chmod +x $BIN_DIR/python2.7 $BIN_DIR/python2

# Update environment variables that are sourced at dyno startup
mkdir -p "$BUILD_DIR"/.profile.d
cat <<EOF >"$BUILD_DIR"/.profile.d/deployer.sh
export PATH=/app/vendor/bin:/app/vendor/deployer/heroku-client/bin:/app/vendor/deployer/go/bin:/app/vendor/deployer/go-deps/bin:$PATH
export GOROOT=/app/vendor/deployer/go
export GOPATH=/app/vendor/deployer/go-deps
EOF

echo "-----> I'm done, buddy."
