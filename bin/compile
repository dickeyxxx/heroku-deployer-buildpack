#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

BUILD_DIR=$1
VENDOR_DIR="$BUILD_DIR/vendor/deployer"

mkdir -p $VENDOR_DIR

echo "-----> Installing Heroku Client...."
curl -s https://s3.amazonaws.com/assets.heroku.com/heroku-client/heroku-client.tgz | tar xz
mv heroku-client $VENDOR_DIR

echo "-----> Installing go...."
curl -s https://storage.googleapis.com/golang/go1.7.3.linux-amd64.tar.gz | tar xz
mv go $VENDOR_DIR

export PATH=$VENDOR_DIR/go/bin:$PATH
export GOROOT=$VENDOR_DIR/go
export GOPATH=$VENDOR_DIR/go-deps
mkdir -p $VENDOR_DIR/go-deps

go get github.com/dullgiulio/pingo
pushd $GOPATH/src/github.com/dullgiulio/pingo
make
popd

go get github.com/dailymuse/gosass
pushd $GOPATH/src/github.com/dailymuse/gosass
make install
popd

mkdir -p "$BUILD_DIR"/.profile.d
cat <<EOF >"$BUILD_DIR"/.profile.d/deployer.sh
export PATH=/app/vendor/deployer/heroku-client/bin:/app/vendor/deployer/go/bin:$PATH
export GOROOT=/app/vendor/deployer/go
export GOPATH=/app/vendor/deployer/go-deps
EOF

echo "-----> I'm done, buddy."
